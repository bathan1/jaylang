<!DOCTYPE html>
<html lang="en-US" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Embed types as expressions | Bluejay</title>
    <meta name="description" content="Next level type safety">
    <meta name="generator" content="VitePress v2.0.0-alpha.15">
    <link rel="preload stylesheet" href="/assets/style.tE5om2fv.css" as="style">
    <link rel="preload stylesheet" href="/vp-icons.css" as="style">
    
    <script type="module" src="/assets/app.DJZDkpTN.js"></script>
    <link rel="preload" href="/assets/inter-roman-latin.Di8DUHzh.woff2" as="font" type="font/woff2" crossorigin="">
    <link rel="modulepreload" href="/assets/chunks/theme.BKbDChgx.js">
    <link rel="modulepreload" href="/assets/chunks/framework.Cga242Po.js">
    <link rel="modulepreload" href="/assets/spec_embed.md.BkGgsTnT.lean.js">
    <script id="check-dark-mode">(()=>{const e=localStorage.getItem("vitepress-theme-appearance")||"auto",a=window.matchMedia("(prefers-color-scheme: dark)").matches;(!e||e==="auto"?a:e==="dark")&&document.documentElement.classList.add("dark")})();</script>
    <script id="check-mac-os">document.documentElement.classList.toggle("mac",/Mac|iPhone|iPod|iPad/i.test(navigator.platform));</script>
  </head>
  <body>
    <div id="app"><div class="Layout" data-v-1df9f90f><!--[--><!--]--><!--[--><span tabindex="-1" data-v-331ec75c></span><a href="#VPContent" class="VPSkipLink visually-hidden" data-v-331ec75c>Skip to content</a><!--]--><!----><header class="VPNav" data-v-1df9f90f data-v-da52a441><div class="VPNavBar" data-v-da52a441 data-v-70946a35><div class="wrapper" data-v-70946a35><div class="container" data-v-70946a35><div class="title" data-v-70946a35><div class="VPNavBarTitle has-sidebar" data-v-70946a35 data-v-1e38c6bc><a class="title" href="/" data-v-1e38c6bc><!--[--><!--]--><!----><span data-v-1e38c6bc>Bluejay</span><!--[--><!--]--></a></div></div><div class="content" data-v-70946a35><div class="content-body" data-v-70946a35><!--[--><!--]--><div class="VPNavBarSearch search" data-v-70946a35><!----></div><nav aria-labelledby="main-nav-aria-label" class="VPNavBarMenu menu" data-v-70946a35 data-v-39714824><span id="main-nav-aria-label" class="visually-hidden" data-v-39714824> Main Navigation </span><!--[--><!--[--><a class="VPLink link VPNavBarMenuLink" href="/" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>Home</span><!--]--></a><!--]--><!--[--><a class="VPLink link vp-external-link-icon VPNavBarMenuLink" href="/_html/index.html" target="_blank" rel="noreferrer" tabindex="0" data-v-39714824 data-v-52a1d768><!--[--><span data-v-52a1d768>API Reference</span><!--]--></a><!--]--><!--]--></nav><!----><div class="VPNavBarAppearance appearance" data-v-70946a35 data-v-6c893767><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-6c893767 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div><div class="VPSocialLinks VPNavBarSocialLinks social-links" data-v-70946a35 data-v-0394ad82 data-v-d07f11e6><!--[--><a class="VPSocialLink no-icon" href="https://github.com/vuejs/vitepress" aria-label="github" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-github"></span></a><!--]--></div><div class="VPFlyout VPNavBarExtra extra" data-v-70946a35 data-v-bf2fac68 data-v-42cb505d><button type="button" class="button" aria-haspopup="true" aria-expanded="false" aria-label="extra navigation" data-v-42cb505d><span class="vpi-more-horizontal icon" data-v-42cb505d></span></button><div class="menu" data-v-42cb505d><div class="VPMenu" data-v-42cb505d data-v-25a6cce8><!----><!--[--><!--[--><!----><div class="group" data-v-bf2fac68><div class="item appearance" data-v-bf2fac68><p class="label" data-v-bf2fac68>Appearance</p><div class="appearance-action" data-v-bf2fac68><button class="VPSwitch VPSwitchAppearance" type="button" role="switch" title aria-checked="false" data-v-bf2fac68 data-v-5337faa4 data-v-1d5665e3><span class="check" data-v-1d5665e3><span class="icon" data-v-1d5665e3><!--[--><span class="vpi-sun sun" data-v-5337faa4></span><span class="vpi-moon moon" data-v-5337faa4></span><!--]--></span></span></button></div></div></div><div class="group" data-v-bf2fac68><div class="item social-links" data-v-bf2fac68><div class="VPSocialLinks social-links-list" data-v-bf2fac68 data-v-d07f11e6><!--[--><a class="VPSocialLink no-icon" href="https://github.com/vuejs/vitepress" aria-label="github" target="_blank" rel="me noopener" data-v-d07f11e6 data-v-591a6b30><span class="vpi-social-github"></span></a><!--]--></div></div></div><!--]--><!--]--></div></div></div><!--[--><!--]--><button type="button" class="VPNavBarHamburger hamburger" aria-label="mobile navigation" aria-expanded="false" aria-controls="VPNavScreen" data-v-70946a35 data-v-e5dd9c1c><span class="container" data-v-e5dd9c1c><span class="top" data-v-e5dd9c1c></span><span class="middle" data-v-e5dd9c1c></span><span class="bottom" data-v-e5dd9c1c></span></span></button></div></div></div></div><div class="divider" data-v-70946a35><div class="divider-line" data-v-70946a35></div></div></div><!----></header><div class="VPLocalNav has-sidebar empty" data-v-1df9f90f data-v-db738f89><div class="container" data-v-db738f89><button class="menu" aria-expanded="false" aria-controls="VPSidebarNav" data-v-db738f89><span class="vpi-align-left menu-icon" data-v-db738f89></span><span class="menu-text" data-v-db738f89>Menu</span></button><div class="VPLocalNavOutlineDropdown" style="--vp-vh:0px;" data-v-db738f89 data-v-0bf0e06f><button data-v-0bf0e06f>Return to top</button><!----></div></div></div><aside class="VPSidebar" data-v-1df9f90f data-v-af661f50><div class="curtain" data-v-af661f50></div><nav class="nav" id="VPSidebarNav" aria-labelledby="sidebar-aria-label" tabindex="-1" data-v-af661f50><span class="visually-hidden" id="sidebar-aria-label" data-v-af661f50> Sidebar Navigation </span><!--[--><!--]--><!--[--><div class="no-transition group" data-v-8d50c081><section class="VPSidebarItem level-0" data-v-8d50c081 data-v-d81de50c><div class="item" role="button" tabindex="0" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><h2 class="text" data-v-d81de50c>Language</h2><!----></div><div class="items" data-v-d81de50c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/language/bluejay.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Bluejay</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-8d50c081><section class="VPSidebarItem level-0" data-v-8d50c081 data-v-d81de50c><div class="item" role="button" tabindex="0" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><h2 class="text" data-v-d81de50c>Implementation</h2><!----></div><div class="items" data-v-d81de50c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/implementation/z3.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Z3</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/implementation/smt.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>SMT</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><div class="no-transition group" data-v-8d50c081><section class="VPSidebarItem level-0 has-active" data-v-8d50c081 data-v-d81de50c><div class="item" role="button" tabindex="0" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><h2 class="text" data-v-d81de50c>Spec</h2><!----></div><div class="items" data-v-d81de50c><!--[--><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/spec/commentary.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Commentary</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/spec/desugar.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Desugar</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/spec/embed.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Embed</p><!--]--></a><!----></div><!----></div><div class="VPSidebarItem level-1 is-link" data-v-d81de50c data-v-d81de50c><div class="item" data-v-d81de50c><div class="indicator" data-v-d81de50c></div><a class="VPLink link link" href="/spec/type_erasure.html" data-v-d81de50c><!--[--><p class="text" data-v-d81de50c>Type Erasure</p><!--]--></a><!----></div><!----></div><!--]--></div></section></div><!--]--><!--[--><!--]--></nav></aside><div class="VPContent has-sidebar" id="VPContent" data-v-1df9f90f data-v-c87f25bf><div class="VPDoc has-sidebar has-aside" data-v-c87f25bf data-v-7011f0d8><!--[--><!--]--><div class="container" data-v-7011f0d8><div class="aside" data-v-7011f0d8><div class="aside-curtain" data-v-7011f0d8></div><div class="aside-container" data-v-7011f0d8><div class="aside-content" data-v-7011f0d8><div class="VPDocAside" data-v-7011f0d8 data-v-3f215769><!--[--><!--]--><!--[--><!--]--><nav aria-labelledby="doc-outline-aria-label" class="VPDocAsideOutline" data-v-3f215769 data-v-60d5052e><div class="content" data-v-60d5052e><div class="outline-marker" data-v-60d5052e></div><div aria-level="2" class="outline-title" id="doc-outline-aria-label" role="heading" data-v-60d5052e>On this page</div><ul class="VPDocOutlineItem root" data-v-60d5052e data-v-1ce71065><!--[--><!--]--></ul></div></nav><!--[--><!--]--><div class="spacer" data-v-3f215769></div><!--[--><!--]--><!----><!--[--><!--]--><!--[--><!--]--></div></div></div></div><div class="content" data-v-7011f0d8><div class="content-container" data-v-7011f0d8><!--[--><!--]--><main class="main" data-v-7011f0d8><div style="position:relative;" class="vp-doc _spec_embed" data-v-7011f0d8><div><h1 id="embed-types-as-expressions" tabindex="-1">Embed types as expressions <a class="header-anchor" href="#embed-types-as-expressions" aria-label="Permalink to “Embed types as expressions”">​</a></h1><p>We take the desugared target and embed it into a low-level language. We use the term &quot;embed&quot; because we most of the logic done in this step is taking types and embedding them as expressions in the target code.</p><p>Definitions:</p><ul><li>Double square brackets <code>[[ . ]]</code> is a mapping to embed the desugared code.</li><li>A tilde <code>~</code> prefixes a reserved label that the programmer cannot create.</li><li>A dollar sign <code>$</code> prefixes a fresh name.</li></ul><p>Anything that is not explicitly mapped in this specification is handled trivially by recursively embedding the components and reconstructing the same structure again.</p><h1 id="target-language" tabindex="-1">Target language <a class="header-anchor" href="#target-language" aria-label="Permalink to “Target language”">​</a></h1><p>The target of the embedding can be found pushed in the <code>main</code> branch in the Jaylang repo at <code>src/lang/ast.ml</code></p><p>It is simply desugared Bluejay without the types, but it has gained freeze, thaw, id, and casing (which could be sugar for nested conditionals, but we like that they easily give n-ary branches).</p><h2 id="statements" tabindex="-1">Statements <a class="header-anchor" href="#statements" aria-label="Permalink to “Statements”">​</a></h2><p>Programs are statement lists. A statement is a let-expression without a continuation.</p><p>Statements are embedded exactly like their corresponding let-expression as it is defined in this document.</p><h2 id="types" tabindex="-1">Types <a class="header-anchor" href="#types" aria-label="Permalink to “Types”">​</a></h2><h3 id="int-and-bool" tabindex="-1">Int and bool <a class="header-anchor" href="#int-and-bool" aria-label="Permalink to “Int and bool”">​</a></h3><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[[int]] =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  { ~gen = freeze pick_i</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ; ~check = fun $e -&gt; match $e with int -&gt; ()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ; ~wrap = fun $e -&gt; $e</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[[bool]] =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  { ~gen = freeze pick_b</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ; ~check = fun $e -&gt; match $e with bool -&gt; ()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ; ~wrap = fun $e -&gt; $e</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span></code></pre></div><h3 id="function-type" tabindex="-1">Function type <a class="header-anchor" href="#function-type" aria-label="Permalink to “Function type”">​</a></h3><p>There is a lot of overlap between all four variations created by two toggles:</p><ol><li>Dependent</li><li>Deterministic</li></ol><p>We are wordy here and write out the full definition for each, but the implementation makes use of the overlap, though the code is not necessarily that clean because of it.</p><p>Note that <code>det</code> forces any execution inside of it to not use any nondeterminism, unless that nondeterminism is used in an <code>escape_det</code>.</p><p><code>tbl_appl</code> uses the table to lookup up the associated value, and the table is mutated to map to a new generated value if the key didn&#39;t exist.</p><p>Nonces are used to differentiate generated functions.</p><h4 id="basic-function-type" tabindex="-1">Basic function type <a class="header-anchor" href="#basic-function-type" aria-label="Permalink to “Basic function type”">​</a></h4><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[[tau1 -&gt; tau2]] =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  { ~gen = freeze @@</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">    let</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;">nonce</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pick_i in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    fun $arg -&gt; </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">      let</span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;"> _</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">nonce in</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">      let</span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;"> _</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> [[</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tau1</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">]]</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">check </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">arg in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      thaw [[tau2]].~gen</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ; ~check = fun $e -&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    [[tau2]].~check ($e (escape_det(thaw [[tau1]].~gen)))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ; ~wrap = fun $e -&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    fun $arg -&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">      let</span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;"> _</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> [[</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tau1</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">]]</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">check </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">arg in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      [[tau2]].~wrap ($e ([[tau1]].~wrap $arg))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span></code></pre></div><h4 id="deterministic-function-type" tabindex="-1">Deterministic function type <a class="header-anchor" href="#deterministic-function-type" aria-label="Permalink to “Deterministic function type”">​</a></h4><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[[tau1 --&gt; tau2]] =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  { ~gen = freeze @@ </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">    let</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;">nonce</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pick_i in</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">    let</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;">tb</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> table in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    fun $arg -&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">      let</span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;"> _</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">nonce in</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">      let</span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;"> _</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> [[</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tau1</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">]]</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">check </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">arg in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      tbl_appl($tb, thaw [[tau2]].~gen, $arg)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ; ~check = fun $e -&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    [[tau2]].~check (det($e (escape_det(thaw [[tau1]].~gen))))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ; ~wrap = fun $e -&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    fun $arg -&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">      let</span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;"> _</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> [[</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tau1</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">]]</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">check </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">arg in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      [[tau2]].~wrap ($e ([[tau1]].~wrap $arg))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span></code></pre></div><p>Notes:</p><ul><li>The <code>det</code> ensures that the application of <code>$e</code> is deterministic.</li></ul><h4 id="dependent-function-type" tabindex="-1">Dependent function type <a class="header-anchor" href="#dependent-function-type" aria-label="Permalink to “Dependent function type”">​</a></h4><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[[(x : tau_1) -&gt; tau_2]] =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  { ~gen = freeze @@</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">    let</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;">nonce</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pick_i in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    fun $arg -&gt; </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">      let</span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;"> _</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">nonce in</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">      let</span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;"> _</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> [[</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tau1</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">]]</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">check </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">arg in</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">      let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">arg in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      thaw [[tau_2]].~gen</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ; ~check = fun $e -&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">    let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> escape_det(thaw </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[[</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tau_1</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">]]</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">gen) in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    [[tau_2]].~check ($e x)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ; ~wrap = fun $e -&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    fun $arg -&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">      let</span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;"> _</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> [[</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tau_1</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">]]</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">check </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">arg in</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">      let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> [[</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tau_1</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">]]</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">wrap </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">arg in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      [[tau_2]].~wrap ($e x)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span></code></pre></div><h4 id="dependent-deterministic-function-type" tabindex="-1">Dependent deterministic function type <a class="header-anchor" href="#dependent-deterministic-function-type" aria-label="Permalink to “Dependent deterministic function type”">​</a></h4><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[[(x : tau_1) -&gt; tau_2]] =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  { ~gen = freeze @@</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">    let</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;">nonce</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pick_i in</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">    let</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;">tb</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> table in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    fun $arg -&gt; </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">      let</span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;"> _</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">nonce in</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">      let</span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;"> _</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> [[</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tau1</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">]]</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">check </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">arg in</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">      let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">arg in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      tbl_appl($tb, thaw [[tau_2]].~gen, x)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ; ~check = fun $e -&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">    let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> escape_det(thaw </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[[</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tau_1</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">]]</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">gen) in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    [[tau_2]].~check det($e x)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ; ~wrap = fun $e -&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    fun $arg -&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">      let</span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;"> _</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> [[</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tau_1</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">]]</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">check </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">arg in</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">      let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> [[</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tau_1</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">]]</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">wrap </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">arg in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      [[tau_2]].~wrap ($e x)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span></code></pre></div><h3 id="recursive-types" tabindex="-1">Recursive types <a class="header-anchor" href="#recursive-types" aria-label="Permalink to “Recursive types”">​</a></h3><h4 id="standard" tabindex="-1">Standard <a class="header-anchor" href="#standard" aria-label="Permalink to “Standard”">​</a></h4><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[[mu B x1 ... xn. tau]] =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  thaw @@</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  Y (fun $self -&gt; freeze @@ fun x1 -&gt; ... -&gt; fun xn -&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    { ~gen = freeze @@</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">      let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> B</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> thaw </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">self in thaw [[tau]].~gen</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ; ~check = fun $e -&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">      let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> B</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> thaw </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">self in [[tau]].~check $e</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ; ~wrap = fun $e -&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">      let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> B</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> thaw </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">self in [[tau]].~wrap $e</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  )</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Y = </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  fun f -&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    (fun x -&gt; freeze (thaw (f (x x))))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    (fun x -&gt; freeze (thaw (f (x x))))</span></span></code></pre></div><p>Notes:</p><ul><li>This Y-combinator is special-made with freezing and thawing because this is its only use case.</li></ul><h4 id="with-type-splaying" tabindex="-1">With type-splaying <a class="header-anchor" href="#with-type-splaying" aria-label="Permalink to “With type-splaying”">​</a></h4><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[[mu B x1 ... xn. tau]] =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  Y (fun $self -&gt; fun $depth -&gt; fun x1 -&gt; ... fun xn -&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    { ~gen = freeze @@</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      if $depth == 0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      then </span><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> B</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> [[</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">`</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Stubbed_mu of </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">unit</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">]]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> in `~Stub (thaw [[tau]].~gen) </span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">(* Replaced B with some type the user cannot make *)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      else </span><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> B</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">self (</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">depth </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) in thaw [[tau]].~gen </span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">(* still have some depth allowed, so continue normally *)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ; ~check = fun $e -&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      match $e with</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      | `~Stub $gend -&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">        let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> B</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> [[</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">`</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Stubbed_mu of </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">unit</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">]]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        [[tau]].~check $gend</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      | PUntouchable _ </span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">(* underscore cannot match untouchable, so combine the cases *)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      | _ -&gt; </span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">(* run the normal checker *)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">        let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> B</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">self (</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">depth </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) in [[tau]].~check $e </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ; ~wrap = fun $e -&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      match $e with</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      | `Stub _ -&gt; $e </span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">(* we can assume that $e checks out against $tau, so no wrapping to do *)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      | PUntouchable _ </span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">(* underscore cannot match untouchable, so combine the cases *)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      | _ -&gt; </span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">(* use the normal wrapper *)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">        let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> B</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">self (</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">depth </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) in [[tau]].~wrap $e</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ) 3 </span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">(* allowed depth is three by default *)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Y = </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  fun f -&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    (fun x -&gt; fun i -&gt; f (x x) i)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    (fun x -&gt; fun i -&gt; f (x x) i)</span></span></code></pre></div><p>Notes:</p><ul><li>If the user is type-splaying their recursive functions, then they&#39;ll also expect that recursive types can be cut short</li><li>Notice that this match comes after the desugaring phase, so it is allowed to catch literally anything, including untouchable values</li></ul><h3 id="variant-declarations" tabindex="-1">Variant declarations <a class="header-anchor" href="#variant-declarations" aria-label="Permalink to “Variant declarations”">​</a></h3><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[[V_0 of tau_0 | ... | V_n of tau_n]] =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  { ~gen = freeze @@</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    if pick_i == 123456789 </span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">(* unlikely number to pick *)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    then</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">      (* generate a constructor that is potentially recursive *)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      case pick_i on</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      | 1 -&gt; V_i1 (thaw [[tau_i1]].~gen)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      | ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      | m -&gt; V_im (thaw [[tau_im]].~gen)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      | _ -&gt; V_i0 (thaw [[tau_i0]].~gen)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    else</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">      (* generate a constructor that is more likely to be terminal *)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      case pick_i on</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      | 1 -&gt; V_j1 (thaw [[tau_j1]].~gen)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      | ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      | l -&gt; V_jl (thaw [[tau_jl]].~gen)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      | _ -&gt; V_j0 (thaw [[tau_j0]].~gen)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ; ~check = fun $e -&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    match $e with</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    | V_0 $v -&gt; [[tau_0]].~check $v</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    | ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    | V_n $v -&gt; [[tau_n]].~check $v</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ; ~wrap = fun $e -&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    match $e with</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    | V_0 $v -&gt; V_0 ([[tau_0]].~wrap $v)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    | ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    | V_n $v -&gt; V_n ([[tau_n]].~wrap $v)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span></code></pre></div><p>Notes:</p><ul><li><code>i0,...,im, j0,...,jl</code> are a permutation of <code>0,...,n</code>, and <code>tau_i0,...,tau_im</code> contain in their AST the identifier of some in-scope mu type variable while <code>tau_j0,...,tau_jl</code> do not.</li><li>No <code>case</code> in the generation is needed when there is only one variant constructor. In such a scenario, the entire <code>gen</code> is replaced the <code>default</code> case.</li></ul><h3 id="record-types" tabindex="-1">Record types <a class="header-anchor" href="#record-types" aria-label="Permalink to “Record types”">​</a></h3><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[[{ l_0 : tau_0 ; ... ; l_n : tau_n }]] =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  { ~gen = freeze @@</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    { l_0 = thaw [[tau_0]].~gen ; ... ; l_n = thaw [[tau_n]].~gen }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ; ~check = fun $e -&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    match $e with</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    | record -&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">      let</span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;"> _</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> [[</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tau_0</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">]]</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">check </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">l_0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">      let</span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;"> _</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> [[</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tau_n</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">]]</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">check </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">l_n</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ; ~wrap = fun $e -&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    { l_0 = [[tau_0]].~wrap $e.l_0 ; ... ; l_n = [[tau_n]].~wrap $e.l_n }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span></code></pre></div><h3 id="refinement-types" tabindex="-1">Refinement types <a class="header-anchor" href="#refinement-types" aria-label="Permalink to “Refinement types”">​</a></h3><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[[{ tau | e_p }]] =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  { ~gen = freeze @@</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">    let</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;">candidate</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> thaw </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[[</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tau</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">]]</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">gen in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    if det([[ e_p ]] $candidate)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    then $candidate</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    else vanish </span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">(* i.e. safely quit *)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ; ~check = fun $e -&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">    let</span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;"> _</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> [[</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tau</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">]]</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">check </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    if det([[ e_p ]] $e)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    then ()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    else abort &quot;Failed predicate&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ; ~wrap = fun $e -&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    [[tau]].~wrap $e</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span></code></pre></div><p>Notes:</p><ul><li>Refinements must run deterministically.</li></ul><h3 id="type-polymorphic-types" tabindex="-1">Type / polymorphic types <a class="header-anchor" href="#type-polymorphic-types" aria-label="Permalink to “Type / polymorphic types”">​</a></h3><p>Because of the desugaring, we only have types and dependent types instead of polymorphic functions. See the desugaring, and then see the definition of <code>type</code> here.</p><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[[ </span><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ]] =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  { ~gen = freeze @@</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">    let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> i</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> pick_i in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    { ~gen = freeze @@ Untouchable { ~i = i ; ~nonce = pick_i }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ; ~check = fun $e -&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      match $e with</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      | Untouchable v -&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        if v.~i == i</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        then ()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        else abort &quot;Non-equal untouchable values&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ; ~wrap = fun $e -&gt; $e</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ; ~check = fun $e -&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">    let</span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;"> _</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e.</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">gen in</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">    let</span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;"> _</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e.</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">check in</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">    let</span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;"> _</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e.</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">wrap in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ; ~wrap = fun $e -&gt; $e</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span></code></pre></div><h3 id="top-bottom" tabindex="-1">Top/bottom <a class="header-anchor" href="#top-bottom" aria-label="Permalink to “Top/bottom”">​</a></h3><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[[ top ]] = </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  { ~gen = freeze @@ `~Top { ~nonce = pick_i }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ; ~check = fun _ -&gt; () </span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">(* anything is in top *)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ; ~wrap = fun $e -&gt; $e</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[[ bottom ]] =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  { ~gen = freeze @@ vanish </span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">(* can&#39;t make a value of type bottom, so exit safely *)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ; ~check = fun _ -&gt; abort &quot;Nothing is in bottom&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ; ~wrap = fun $e -&gt; $e</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span></code></pre></div><h3 id="unit" tabindex="-1">Unit <a class="header-anchor" href="#unit" aria-label="Permalink to “Unit”">​</a></h3><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[[ unit ]] =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  { ~gen = freeze ()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ; ~check = fun $e -&gt; match $e with unit -&gt; ()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ; ~wrap = fun $e -&gt; $e  }</span></span></code></pre></div><h3 id="module-types" tabindex="-1">Module types <a class="header-anchor" href="#module-types" aria-label="Permalink to “Module types”">​</a></h3><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[[ sig </span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;">val</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> l_0</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau_0 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">...</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;"> val</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> l_n</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau_n end ]] =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  { ~gen = freeze struct</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">      let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> l_0</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> thaw </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[[</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tau_0</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">]]</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">gen</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">      let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> l_</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;">n</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> thaw </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[[</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tau_(n</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">]]</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">gen</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">      let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> l_n</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> thaw </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[[</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tau_n</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">]]</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">gen</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ; ~check = fun $e -&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    match $e with</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    | </span><span style="--shiki-light:#6F42C1;--shiki-light-text-decoration:underline;--shiki-dark:#B392F0;--shiki-dark-text-decoration:underline;">module</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> -&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      let _ = [[tau_0]].~check $e.l_0 in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      let l_0 = $e.l_0 in </span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">(* put the name l_0 in scope *)</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      let _ = [[tau_(n-1)]].~check $e.l_(n-1) in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      let l_(n-1) = $e.l_(n-1) in </span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">(* put the name l_(n-1) in scope *)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      let _ = [[tau_n]].~check $e.l_n in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ; ~wrap = fun $e -&gt; struct</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      let l_0 = [[tau_0]].~wrap $e.l_0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      let l_n = [[tau_n]].~wrap $e.l_n</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    end</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  }</span></span></code></pre></div><p>Notes:</p><ul><li>This is the same as dependent records with the <code>{: :}</code> syntax.</li></ul><h3 id="singleton-type" tabindex="-1">Singleton type <a class="header-anchor" href="#singleton-type" aria-label="Permalink to “Singleton type”">​</a></h3><p>The singleton of a type is just the singleton set containing that type.</p><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[[singlet]] =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  fun $tau -&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    { ~gen = freeze @@ $tau</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ; ~check = fun $t -&gt; escape_det(</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">        let</span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;"> _</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">  $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tau.</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">check (thaw </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">t.</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">gen) in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        $t.~check (thaw $tau.~gen)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      )</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ; ~wrap = fun $t -&gt; $t</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span></code></pre></div><p>Note:</p><ul><li>The word <code>singlet</code> is used instead of <code>singleton</code> because it only works on types. e.g. <code>singlet 5</code> is bad, whereas a programmer might expect <code>singleton 5</code> to work.</li><li>The check goes in both directions: it first asks if <code>t</code> is a subtype of <code>tau</code> (anything that <code>t</code> generates is in <code>tau</code>) and then that <code>tau</code> is a subtype of <code>t</code>, giving equality.</li><li>Since the checker requires generating, but the generated values cannot escape, we escape any determinism block.</li></ul><h3 id="intersection-types" tabindex="-1">Intersection types <a class="header-anchor" href="#intersection-types" aria-label="Permalink to “Intersection types”">​</a></h3><p>The &quot;intersection&quot; type has been desugared into a dependent function, so nothing is needed here.</p><h3 id="list-type" tabindex="-1">List type <a class="header-anchor" href="#list-type" aria-label="Permalink to “List type”">​</a></h3><p>The <code>list</code> type has been desugared into a variant, so nothing is needed here.</p><h4 id="other-encodings" tabindex="-1">Other encodings <a class="header-anchor" href="#other-encodings" aria-label="Permalink to “Other encodings”">​</a></h4><p>These ideas are not in the implementation. The only one here (refinement types as dependent records) is just an encoding we could do, but it is not a simple desugar because it requires nontrivial projection of the <code>~value</code> label.</p><h3 id="refinement-types-as-dependent-records" tabindex="-1">Refinement types as dependent records <a class="header-anchor" href="#refinement-types-as-dependent-records" aria-label="Permalink to “Refinement types as dependent records”">​</a></h3><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[[ { tau | e_p }]] =</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">  let</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;">r</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> [[</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> {</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">:</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ~</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">value</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">dummy </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> if e_p </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> then unit else </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">bottom</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">} ]] in (* note this is a dependent record *)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  {</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ~</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">gen</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> freeze @@</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    (thaw $</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">r</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">gen)</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">value</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">  ;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ~</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">check</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fun </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">    $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">r</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">check </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ~</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">value</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ~</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dummy</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">}</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">  ;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ~</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">wrap</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fun </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">    $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">r</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">wrap </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">{</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ~</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">value</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">e </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ~</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">dummy</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> () </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">}</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">  }</span></span></code></pre></div><h2 id="semantic-expressions" tabindex="-1">Semantic expressions <a class="header-anchor" href="#semantic-expressions" aria-label="Permalink to “Semantic expressions”">​</a></h2><h3 id="let" tabindex="-1">Let <a class="header-anchor" href="#let" aria-label="Permalink to “Let”">​</a></h3><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[[ </span><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;">x</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau) </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> e in e&#39; ]] =</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">  let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">    let</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;">v</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> [[</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> e </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">]]</span><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;"> in</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">    let</span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;"> _</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> [[</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tau</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">]]</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">check </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">v </span><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">in</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    [[</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tau</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">]]</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">wrap </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">v</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  [[ e&#39; ]]</span></span></code></pre></div><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">(* with this flag, we don&#39;t run the checker--only wrap *)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[[ let_no_check (x : tau) = e in e&#39; ]] =</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">  let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">    [[</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tau</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">]]</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">wrap </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">[[</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> e </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">]]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  [[ e&#39; ]]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">(* with this flag, we don&#39;t wrap--only run the checker *)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[[ let_no_wrap (x : tau) = e in e&#39; ]] =</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">  let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">    let</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;">v</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> [[</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> e </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">]]</span><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;"> in</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">    let</span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;"> _</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> [[</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tau</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">]]</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">check </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">$</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">v </span><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">in</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">    $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">v</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  [[ e&#39; ]]</span></span></code></pre></div></div></div></main><footer class="VPDocFooter" data-v-7011f0d8 data-v-e257564d><!--[--><!--]--><!----><nav class="prev-next" aria-labelledby="doc-footer-aria-label" data-v-e257564d><span class="visually-hidden" id="doc-footer-aria-label" data-v-e257564d>Pager</span><div class="pager" data-v-e257564d><a class="VPLink link pager-link prev" href="/spec/desugar.html" data-v-e257564d><!--[--><span class="desc" data-v-e257564d>Previous page</span><span class="title" data-v-e257564d>Desugar</span><!--]--></a></div><div class="pager" data-v-e257564d><a class="VPLink link pager-link next" href="/spec/type_erasure.html" data-v-e257564d><!--[--><span class="desc" data-v-e257564d>Next page</span><span class="title" data-v-e257564d>Type Erasure</span><!--]--></a></div></nav></footer><!--[--><!--]--></div></div></div><!--[--><!--]--></div></div><!----><!--[--><!--]--></div></div>
    <script>window.__VP_HASH_MAP__=JSON.parse("{\"implementation_smt.md\":\"DiV-R8OV\",\"implementation_z3.md\":\"bCzCiqEU\",\"index.md\":\"Dzb6Be6W\",\"language_bluejay.md\":\"DcETa2bC\",\"language_index.md\":\"CIebVLoe\",\"spec_commentary.md\":\"BQIXnmP_\",\"spec_desugar.md\":\"CkC_H7-y\",\"spec_embed.md\":\"BkGgsTnT\",\"spec_index.md\":\"DkBvsxUd\",\"spec_type_erasure.md\":\"JOJ0O5NV\"}");window.__VP_SITE_DATA__=JSON.parse("{\"lang\":\"en-US\",\"dir\":\"ltr\",\"title\":\"Bluejay\",\"description\":\"Next level type safety\",\"base\":\"/\",\"head\":[],\"router\":{\"prefetchLinks\":true},\"appearance\":true,\"themeConfig\":{\"nav\":[{\"text\":\"Home\",\"link\":\"/\"},{\"text\":\"API Reference\",\"link\":\"/_html/index.html\",\"target\":\"_blank\"}],\"sidebar\":[{\"text\":\"Language\",\"items\":[{\"text\":\"Bluejay\",\"link\":\"/language/bluejay\"}]},{\"text\":\"Implementation\",\"items\":[{\"text\":\"Z3\",\"link\":\"/implementation/z3\"},{\"text\":\"SMT\",\"link\":\"/implementation/smt\"}]},{\"text\":\"Spec\",\"items\":[{\"text\":\"Commentary\",\"link\":\"/spec/commentary\"},{\"text\":\"Desugar\",\"link\":\"/spec/desugar\"},{\"text\":\"Embed\",\"link\":\"/spec/embed\"},{\"text\":\"Type Erasure\",\"link\":\"/spec/type_erasure\"}]}],\"socialLinks\":[{\"icon\":\"github\",\"link\":\"https://github.com/vuejs/vitepress\"}]},\"locales\":{},\"scrollOffset\":134,\"cleanUrls\":false,\"additionalConfig\":{}}");</script>
    
  </body>
</html>