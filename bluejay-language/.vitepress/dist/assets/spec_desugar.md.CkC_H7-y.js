import{_ as s,c as a,o as n,ah as t}from"./chunks/framework.Cga242Po.js";const g=JSON.parse('{"title":"Desugar","description":"","frontmatter":{},"headers":[],"relativePath":"spec/desugar.md","filePath":"spec/desugar.md"}'),h={name:"spec/desugar.md"};function k(l,i,e,p,r,d){return n(),a("div",null,[...i[0]||(i[0]=[t(`<h1 id="desugar" tabindex="-1">Desugar <a class="header-anchor" href="#desugar" aria-label="Permalink to “Desugar”">​</a></h1><p>We desugar into a subset of Bluejay so that we have fewer translation cases.</p><p>Definitions:</p><ul><li>Paren and bar brackets <code>(| . |)</code> is mapping to desugar Bluejay code.</li><li>A tilde <code>~</code> prefixes a reserved record label that the programmer cannot create.</li><li>A dollar sign <code>$</code> prefixes a fresh name.</li></ul><h1 id="desugared-target" tabindex="-1">Desugared target <a class="header-anchor" href="#desugared-target" aria-label="Permalink to “Desugared target”">​</a></h1><p>The target of the desugaring can be found pushed in the <code>main</code> branch in the Jaylang repo at <code>src/lang/ast.ml</code>.</p><p>Note that we add <code>abort</code>, and <code>vanish</code> in this pass, and everything else exists already in Bluejay.</p><h2 id="statements" tabindex="-1">Statements <a class="header-anchor" href="#statements" aria-label="Permalink to “Statements”">​</a></h2><p>Programs are statement lists. Each statement is a let-expression without a continuation.</p><p>Statements are desugared exactly like their corresponding let-expressions, except each top-level resulting <code>let</code> (e.g. there are many with a recursive function) is its own statement. We need no special cases, and the spec to desugar a statement is inferred from all definitions below and this simple transformation described here.</p><h2 id="functions" tabindex="-1">Functions <a class="header-anchor" href="#functions" aria-label="Permalink to “Functions”">​</a></h2><p>Note that untyped functions are all the same, and we would use untyped let expressions.</p><h3 id="non-rec-functions" tabindex="-1">Non-rec functions <a class="header-anchor" href="#non-rec-functions" aria-label="Permalink to “Non-rec functions”">​</a></h3><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(| </span><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> f</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> a_1</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> a_n</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) (</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;">x_1</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau_1) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;">x_m</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau_m) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">=</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  e</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  e&#39; |) =</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;">f</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a_1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> type) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a_n</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> type) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau_1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau_m </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  fun a_1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fun a_n </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    fun x_1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fun x_m </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      (</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> e </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> e&#39; </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>Notes:</p><ul><li>The back arrow is our notation for a dependent parameter.</li><li>Any dependent parameter <code>(x_i &lt;- tau_i)</code> is instead in the final arrow type as <code>... -&gt; (x_1 : tau_i) -&gt; ...</code>, i.e. the dependent parameters are translated naturally into dependent arrows.</li><li><code>n</code> may be zero (i.e. no type variables), and <code>m</code> is positive, as is enforced in the parser.</li></ul><h3 id="recursive-functions" tabindex="-1">Recursive functions <a class="header-anchor" href="#recursive-functions" aria-label="Permalink to “Recursive functions”">​</a></h3><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(| </span><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">let</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> rec</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> f1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> a1_1</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> a1_n1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) (</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;">x1_1</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau1_1) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;">x1_m1</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau1_m1) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau1 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">=</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    e1</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-light-text-decoration:underline;--shiki-dark:#DBEDFF;--shiki-dark-text-decoration:underline;">  and</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  and fn (</span><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> an_1</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> an_nn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) (xn_1 : taun_1) ... (xn_mn : taun_mn) : taun =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    en</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  e |) =</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">(* this record is never accessible to the user, so we don&#39;t need to create unusable labels *)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">let</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;">r</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Y_n</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fun</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;"> f1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> fun</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;"> fn</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">    let</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">_no_check f1 : (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a1_1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> type) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a1_n1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> type) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau1_1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau1_m1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">=</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      fun a1_1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fun a1_n1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        fun x1_1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fun x1_m1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          (</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> e1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    f1)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">  ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (fun f1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fun fn </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    let_no_check </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fn</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">an_1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> type) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">an_nn</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> type) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> taun_1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> taun_mn </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> taun </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">=</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      fun an_1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fun an_nn </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        fun xn_1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fun xn_mn </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">          (</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> en </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    fn)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">(* first expose the names so that the types can use them *)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">let f1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">r</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">f1</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">let fn </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">=</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">r</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">fn</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">(* then run the checkers on the types, but don&#39;t wrap because that would be a double wrap *)</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">let_no_wrap</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> f1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a1_1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> type) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a1_n1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> type) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau1_1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau1_m1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> f1</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">let_no_wrap </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fn</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">an_1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> type) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">an_nn</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> type) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> taun_1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> taun_mn </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> taun </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> fn</span></span></code></pre></div><p>for <code>Y_n</code> the fixed point combinator on <code>n</code> mutually recursive functions.</p><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Y_n = fun f1 ... fn -&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  Y (fun self f1 ... fn -&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    { l1 = fun x -&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">      let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> r</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> self f1 ... fn in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      f1 r.l1 ... r.ln x</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ; ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ; ln = fun x -&gt;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">      let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> r</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> self f1 ... fn in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      fn r.l1 ... r.ln x</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ) f1 ... fn</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">Y = fun f -&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (fun s -&gt; fun x -&gt; f (s s) x)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (fun s -&gt; fun x -&gt; f (s s) x)</span></span></code></pre></div><p>Notes:</p><ul><li>The same notes as non-rec functions...</li></ul><h3 id="type-splayed-recursive-functions" tabindex="-1">Type splayed recursive functions <a class="header-anchor" href="#type-splayed-recursive-functions" aria-label="Permalink to “Type splayed recursive functions”">​</a></h3><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(| </span><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">let</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> rec</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> f1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> a1_1</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> a1_n1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) (</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;">x1_1</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau1_1) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;">x1_m1</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau1_m1) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau1 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">=</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    e1</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-light-text-decoration:underline;--shiki-dark:#DBEDFF;--shiki-dark-text-decoration:underline;">  and</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  and fn (</span><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> an_1</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> an_nn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) (xn_1 : taun_1) ... (xn_mn : taun_mn) : taun =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    en</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  e |) =</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">(* first generate all the functions, which is recursive in case they refer to each other in their types *)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">let</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;">r</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> Y_n</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fun</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;"> f1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> fun</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;"> fn</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -&gt;</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">    (* simply a generated member of f1&#39;s type *)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ((a1_1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> type) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (a1_n1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> type) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">|</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;"> tau1_1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> |</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">|</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;"> tau1_m1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> |</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">|</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;"> tau1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> |</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">gen</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  )</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">  ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">fun</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;"> f1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> fun</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;"> fn</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ((an_1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> type) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (an_nn </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> type) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">|</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;"> taun_1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> |</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">|</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;"> taun_mn</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> |</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">|</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;"> taun</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> |</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">gen</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  )</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">(* now expose the names so that the types can use them *)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> f1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">f1</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fn</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">r</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fn</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">(* then actually check and wrap the real implementations, which can call the generated functions above *)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> f1</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a1_1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> type) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a1_n1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> type) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau1_1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau1_m1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> e1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">let </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fn</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">an_1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> type) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">an_nn</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> type) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> taun_1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> taun_mn </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> taun </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> en </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>Notes:</p><ul><li>Notice that we&#39;re looking ahead a bit and calling the <code>~gen</code> label here. This is a crossing of boundaries, but it is smooth, so I&#39;m fine with it.</li><li>Each function that does not have types on it is desugared in the normal way.</li><li>We don&#39;t escape any determinism blocks, so this is incomplete in the presence of deterministic functions.</li></ul><h4 id="when-we-don-t-allow-recursive-calls-in-the-types-which-is-incomplete-anyways" tabindex="-1">When we don&#39;t allow recursive calls in the types (which is incomplete anyways): <a class="header-anchor" href="#when-we-don-t-allow-recursive-calls-in-the-types-which-is-incomplete-anyways" aria-label="Permalink to “When we don&#39;t allow recursive calls in the types (which is incomplete anyways):”">​</a></h4><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(| </span><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">let</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> rec</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> f1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> a1_1</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> a1_n1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) (</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;">x1_1</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau1_1) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;">x1_m1</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau1_m1) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau1 </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">=</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    e1</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-light-text-decoration:underline;--shiki-dark:#DBEDFF;--shiki-dark-text-decoration:underline;">  and</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  and fn (</span><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> an_1</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> an_nn</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) (xn_1 : taun_1) ... (xn_mn : taun_mn) : taun =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    en</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  e |) =</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">(* first expose the splayed names so that the first layers can use them *)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> f1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ((a1_1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> type) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (a1_n1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> type) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">|</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;"> tau1_1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> |</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">|</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;"> tau1_m1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> |</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">|</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;"> tau1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> |</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">gen</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">...</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> fn</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ((an_1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> type) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (an_nn </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> type) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">|</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;"> taun_1</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> |</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">|</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;"> taun_mn</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> |</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">|</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;"> taun</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> |</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">))</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">gen</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">(* then actually check and wrap the real (first layer) implementations, which can call the generated functions above *)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> f1</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a1_1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> type) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a1_n1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> type) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau1_1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau1_m1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> e1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">let </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">fn</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">an_1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> type) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">an_nn</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> type) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> taun_1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> taun_mn </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> taun </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> en </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>Notes:</p><ul><li>This only works when all recursive functions have types and when the types don&#39;t refer to the mutually recursive functions.</li><li>TODO: I haven&#39;t actually implemented this yet because it&#39;s even more restrictive, but it&#39;s what we want to sell in the paper.</li></ul><h3 id="multi-arg-functions" tabindex="-1">Multi-arg functions <a class="header-anchor" href="#multi-arg-functions" aria-label="Permalink to “Multi-arg functions”">​</a></h3><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(| fun x1 ... xn -&gt; e |) =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  fun x1 -&gt; ... -&gt; fun xn -&gt; (| e |)</span></span></code></pre></div><h2 id="list" tabindex="-1">List <a class="header-anchor" href="#list" aria-label="Permalink to “List”">​</a></h2><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> filter_list</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;"> x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">  match</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">with</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  |</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> \`</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">~</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Nil</span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;"> _</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">  |</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> \`</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">~</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Cons</span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;"> _</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(| list |) =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  fun $tau -&gt; mu $t.</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  | \`~Nil of unit </span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">(* This is a unique variant name that the user cannot create, and unit is a dummy payload *)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  | \`~Cons of { ~hd : $tau ; ~tl : $t } </span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">(* so is this *)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(| x :: xs |) =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  \`~Cons { ~hd = (| x |) ; ~tl = filter_list (| xs |) }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(| [] |) =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  \`~Nil () </span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(| [ x1 ; ... ; xn ] |) =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (| x1 :: ... :: xn :: [] |)</span></span></code></pre></div><p>Notes:</p><ul><li>We need to instrument cons because otherwise it always looks well-typed. So we filter all things on the right of <code>(::)</code> to be lists.</li></ul><h2 id="pattern-matching" tabindex="-1">Pattern matching <a class="header-anchor" href="#pattern-matching" aria-label="Permalink to “Pattern matching”">​</a></h2><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">(* Empty list pattern *)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(| [] -pat-&gt; e |) =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  \`~Nil -pat-&gt; (| e |)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">(* Cons pattern *)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(| hd :: tl -pat-&gt; e |) =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  \`~Cons $r -pat-&gt; </span><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> hd</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">r.</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">hd in </span><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">let</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> tl</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">r.</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">~</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">tl in (| e |)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(| p -pat-&gt; e |) =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  p -pat-&gt; (| e |)</span></span></code></pre></div><p>Notes:</p><ul><li>This involves desugaring list patterns, which is why we capture the whole <code>pat -&gt; expr</code> instead of pattern and expression separately.</li><li>The semantics of untouchable values is that they only match untouchable patterns and are not capture by <code>any</code> or variables, so there is no need to guard those patterns.</li><li>It is a parse error to have any patterns following a catchall pattern (any/_ or an identifier)</li></ul><h2 id="intersection-types" tabindex="-1">Intersection types <a class="header-anchor" href="#intersection-types" aria-label="Permalink to “Intersection types”">​</a></h2><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(| ((\`V_0 of tau_0) -&gt; tau_0&#39;) &amp; ... &amp; ((\`V_n of tau_n) -&gt; tau_n&#39;) |) =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (| ($x : \`V_0 of tau_0 | ... | \`V_n of tau_n) -&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        match $x with</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        | \`V_0 _ -&gt; tau_0&#39;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        | ...</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        | \`V_n _ -&gt; tau_n&#39; |)</span></span></code></pre></div><h2 id="assert-assume" tabindex="-1">Assert/assume <a class="header-anchor" href="#assert-assume" aria-label="Permalink to “Assert/assume”">​</a></h2><h3 id="without-forall-exists" tabindex="-1">Without forall/exists <a class="header-anchor" href="#without-forall-exists" aria-label="Permalink to “Without forall/exists”">​</a></h3><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(| assert e |) =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  if (| e |)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  then ()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  else abort &quot;Failed assertion&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(| assume e |)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  if (| e |)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  then ()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  else vanish</span></span></code></pre></div><h3 id="with-forall-exists" tabindex="-1">With forall/exists <a class="header-anchor" href="#with-forall-exists" aria-label="Permalink to “With forall/exists”">​</a></h3><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(| assert (forall (</span><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">type</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> a_1</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> a_n</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) (x_1 : tau_1) ... (x_n : tau_m). e) |) =</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">  let</span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;"> _</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a_1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> type) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a_n</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> type) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau_1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau_m </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> unit </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">=</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    fun a_1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a_n </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      fun x_1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x_m </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        (</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> assert e </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ()</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> assume (exists (type a_1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a_n) (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">x_1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau_1) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">x_n</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau_m)</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> e) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">=</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  let </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">_</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a_1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> type) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">a_n</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> type) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau_1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> ...</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> -&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau_m </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> unit </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">=</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    fun a_1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> a_n </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      fun x_1 </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> x_m </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">-&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        (</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> assume </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">e</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> |</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  in</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  ()</span></span></code></pre></div><p>Notes:</p><ul><li>Also supports dependent parameters.</li><li><code>n</code> may be zero, and <code>m</code> is positive.</li><li>In the case that any type is ill-formed in the <code>assume</code>, it will error. The assumption is only on the boolean result and not on the well-formedness of the types.</li><li>There is no meaningful way for this to be interpreted until we get to the embedded language</li><li>We&#39;d like to add intensional equality inside of these, but they can currently be encoded (in a slightly less efficient way) with determinitic functions. It&#39;s just a little tricky or extremely wordy to enforce that at parse time.</li></ul><h2 id="and-or" tabindex="-1">And/or <a class="header-anchor" href="#and-or" aria-label="Permalink to “And/or”">​</a></h2><p>We need to desugar and/or to short-circuit, and this is required so that we can try to solve for the case of the left expression that causes us to evaluate the right expression. This way, in interpretation of the target language, we don&#39;t have to think about how the short-circuiting of the boolean operations affects branches.</p><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(| e &amp;&amp; e&#39; |) =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  if (| e |)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  then (| e&#39; |)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  else false</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(| e || e&#39; |) = </span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  if (| e |)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  then true</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  else (| e&#39; |)</span></span></code></pre></div><h2 id="division-modulo" tabindex="-1">Division/modulo <a class="header-anchor" href="#division-modulo" aria-label="Permalink to “Division/modulo”">​</a></h2><p>Division and modulus can go wrong if right expression is <code>0</code>. We instrument during the desugar process to add this as a branch in the program.</p><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(| e / e&#39; |) =</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">  let</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;">v</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">|</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;"> e&#39;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> |</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) in </span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">(* only evaluate once *)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  if $v == 0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  then abort &quot;Divide by 0&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  else (| e |) / $v</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(| e % e&#39; |) =</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">  let</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> $</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;">v</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">|</span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;"> e&#39;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> |</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) in </span><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">(* only evaluate once *)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  if $v == 0</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  then abort &quot;Modulo by 0&quot;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  else (| e |) % $v</span></span></code></pre></div><h2 id="arrow" tabindex="-1">Arrow <a class="header-anchor" href="#arrow" aria-label="Permalink to “Arrow”">​</a></h2><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(| tau1 -&gt; tau2 |) =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (| tau1 |) -&gt; (| tau2 |)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(| (x : tau1) -&gt; tau2 |) =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (x : (| tau1 |)) -&gt; (| tau2 |)</span></span></code></pre></div><h2 id="parse-time" tabindex="-1">Parse-time <a class="header-anchor" href="#parse-time" aria-label="Permalink to “Parse-time”">​</a></h2><p>The following desugaring steps are trivial and are done while the program is parsed, so there is no language construct for them.</p><p>This is certainly a slight hack, but the scope is small enough that it&#39;s fine for now.</p><h3 id="monadic-syntax" tabindex="-1">Monadic syntax <a class="header-anchor" href="#monadic-syntax" aria-label="Permalink to “Monadic syntax”">​</a></h3><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(| </span><span style="--shiki-light:#D73A49;--shiki-light-text-decoration:underline;--shiki-dark:#F97583;--shiki-dark-text-decoration:underline;">let</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">%</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">bind </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">x</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> e in e&#39; |) =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (| bind e (fun x -&gt; e&#39;) |)</span></span></code></pre></div><p>Notes:</p><ul><li>This implicitly fails if there is no appropriate function called <code>bind</code> in scope</li></ul><h3 id="pipelining" tabindex="-1">Pipelining <a class="header-anchor" href="#pipelining" aria-label="Permalink to “Pipelining”">​</a></h3><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(| e |&gt; e&#39; |) =</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (|  e&#39; e |)</span></span></code></pre></div><p>Notes:</p><ul><li>This means <code>e&#39;</code> is evaluated first, which is a somewhat unintuitive evaluation order, and it motivates actually having the pipelining operator in the language, or desugaring to <code>(fun a b -&gt; b a) e e&#39;</code></li></ul><h3 id="singlet-in-module-types" tabindex="-1">Singlet in module types <a class="header-anchor" href="#singlet-in-module-types" aria-label="Permalink to “Singlet in module types”">​</a></h3><div class="language-ocaml"><button title="Copy Code" class="copy"></button><span class="lang">ocaml</span><pre class="shiki shiki-themes github-light github-dark" style="--shiki-light:#24292e;--shiki-dark:#e1e4e8;--shiki-light-bg:#fff;--shiki-dark-bg:#24292e;" tabindex="0" dir="ltr"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-light-font-weight:bold;--shiki-dark:#79B8FF;--shiki-dark-font-weight:bold;">(* as a line in a module type *)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(| </span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;">val</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> t</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> =</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> tau </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">=</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  (</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> val </span><span style="--shiki-light:#005CC5;--shiki-light-text-decoration:underline;--shiki-dark:#79B8FF;--shiki-dark-text-decoration:underline;">t</span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;"> :</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> singlet (tau) </span><span style="--shiki-light:#032F62;--shiki-dark:#DBEDFF;">|</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre></div><p>Notes:</p><ul><li>This is like OCaml&#39;s <code>type t = tau</code> in a module type. It is simple sugar for the singleton type.</li></ul><h2 id="conclusion" tabindex="-1">Conclusion <a class="header-anchor" href="#conclusion" aria-label="Permalink to “Conclusion”">​</a></h2><p>Unless it was explicitly mentioned in this file, everything else is desugared by just recursively desugaring its components and building back up the same expression.</p>`,74)])])}const F=s(h,[["render",k]]);export{g as __pageData,F as default};
